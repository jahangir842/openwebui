Bootstrap: docker
From: ghcr.io/open-webui/open-webui:main

%labels
    Author Your Name
    Version 1.0.0

%files
    # Add local config files here (if needed)
    # Example:
    # ./config.json /app/backend/config/

%environment
    export LC_ALL=C
    # export WEBUI_SECRET_KEY=your-secret-key-here  # Change this!
    export OLLAMA_API_BASE_URL=http://localhost:11434
    # Force Hugging Face to use local files (no internet)
    export TRANSFORMERS_OFFLINE=1
    export HF_DATASETS_OFFLINE=1

%post
    # Install dependencies (avoid caching to reduce image size)
    apt-get update && apt-get install -y --no-install-recommends \
        python3-pip \
        git \
        && rm -rf /var/lib/apt/lists/*

    pip install --no-cache-dir \
        "huggingface_hub[hf_xet]" \
        sentence-transformers \
        onnxruntime

    # Pre-download models (critical for offline)
    mkdir -p /app/backend/data/cache/huggingface
    python3 -c "
from sentence_transformers import SentenceTransformer
SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2', cache_folder='/app/backend/data/cache')
"

    # Set permissions
    mkdir -p /app/backend/{database,config,logs}
    chmod -R 755 /app/backend

%runscript
    exec /app/backend/start.sh